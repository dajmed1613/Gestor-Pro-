<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Inventario y Ventas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .modal-hidden { display: none; }
        .modal-visible { display: flex; }
        .nav-link.active { background-color: #3b82f6; color: white; }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #3b82f6;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">

    <!-- Contenedor de Autenticaci√≥n -->
    <div id="auth-container" class="min-h-screen flex items-center justify-center p-4">
        <div class="w-full max-w-md bg-gray-800 p-8 rounded-xl shadow-lg">
            <h1 class="text-3xl font-bold text-blue-400 text-center">Gestor Pro</h1>
            <p class="text-center text-sm text-gray-400 -mt-1 mb-6">By Bezalel</p>
            <div id="auth-error" class="bg-red-500/20 text-red-300 p-3 rounded-lg mb-4 text-sm hidden"></div>
            <!-- Formulario de Login -->
            <form id="login-form">
                <div class="space-y-4">
                    <input type="email" id="login-email" placeholder="Correo Electr√≥nico" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg" required>
                    <div class="relative">
                        <input type="password" id="login-password" placeholder="Contrase√±a" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg" required>
                        <button type="button" id="toggle-login-password" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-400 hover:text-gray-200">
                            <!-- SVG Ojo abierto -->
                            <svg class="h-5 w-5 show-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.432 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" />
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                            </svg>
                            <!-- SVG Ojo cerrado -->
                            <svg class="h-5 w-5 hide-icon hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M3.98 8.223A10.477 10.477 0 001.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.45 10.45 0 0112 4.5c4.756 0 8.773 3.162 10.065 7.498a10.523 10.523 0 01-4.293 5.774M6.228 6.228L3 3m3.228 3.228l3.65 3.65m7.894 7.894L21 21m-3.228-3.228l-3.65-3.65m0 0a3 3 0 10-4.243-4.243m4.243 4.243L6.228 6.228" />
                            </svg>
                        </button>
                    </div>
                </div>
                <button type="submit" class="w-full mt-6 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg">Iniciar Sesi√≥n</button>
            </form>
            <!-- Formulario de Registro -->
            <form id="signup-form" class="hidden">
                 <div class="space-y-4">
                    <input type="email" id="signup-email" placeholder="Correo Electr√≥nico" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg" required>
                    <div class="relative">
                        <input type="password" id="signup-password" placeholder="Contrase√±a (m√≠nimo 6 caracteres)" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg" required>
                        <button type="button" id="toggle-signup-password" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-400 hover:text-gray-200">
                             <!-- SVG Ojo abierto -->
                            <svg class="h-5 w-5 show-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.432 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" />
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                            </svg>
                            <!-- SVG Ojo cerrado -->
                            <svg class="h-5 w-5 hide-icon hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M3.98 8.223A10.477 10.477 0 001.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.45 10.45 0 0112 4.5c4.756 0 8.773 3.162 10.065 7.498a10.523 10.523 0 01-4.293 5.774M6.228 6.228L3 3m3.228 3.228l3.65 3.65m7.894 7.894L21 21m-3.228-3.228l-3.65-3.65m0 0a3 3 0 10-4.243-4.243m4.243 4.243L6.228 6.228" />
                            </svg>
                        </button>
                    </div>
                </div>
                <button type="submit" class="w-full mt-6 bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg">Crear Cuenta</button>
            </form>
            <p class="text-center text-sm text-gray-400 mt-6">
                <span id="login-link-text">¬øNo tienes cuenta? <a href="#" id="show-signup" class="text-blue-400 hover:underline">Crea una</a></span>
                <span id="signup-link-text" class="hidden">¬øYa tienes cuenta? <a href="#" id="show-login" class="text-blue-400 hover:underline">Inicia Sesi√≥n</a></span>
            </p>
        </div>
    </div>

    <!-- Contenedor Principal de la App -->
    <div id="app-container" class="hidden">
        <!-- Overlay para el men√∫ m√≥vil -->
        <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-20 hidden md:hidden"></div>
        
        <div class="relative min-h-screen md:flex">
             <!-- Sidebar de Navegaci√≥n -->
            <aside id="sidebar" class="bg-gray-800 text-gray-100 w-64 space-y-6 py-7 px-2 absolute inset-y-0 left-0 transform -translate-x-full md:relative md:translate-x-0 transition duration-200 ease-in-out z-30 flex flex-col">
                 <div class="flex-grow">
                    <div class="flex justify-between items-center px-2">
                      <h1 class="text-2xl font-bold text-blue-400">Gestor Pro</h1>
                      <button id="close-sidebar-btn" class="md:hidden p-1 rounded-full hover:bg-gray-700">
                          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                          </svg>
                      </button>
                    </div>
                    <nav class="mt-8 flex flex-col space-y-2">
                        <a href="#" id="nav-dashboard" class="nav-link active px-4 py-2 rounded-lg hover:bg-blue-500 transition-colors">Dashboard</a>
                        <a href="#" id="nav-inventory" class="nav-link px-4 py-2 rounded-lg hover:bg-blue-500 transition-colors">Inventario</a>
                        <a href="#" id="nav-sales" class="nav-link px-4 py-2 rounded-lg hover:bg-blue-500 transition-colors">Realizar Venta</a>
                        <a href="#" id="nav-purchases" class="nav-link px-4 py-2 rounded-lg hover:bg-blue-500 transition-colors">Registrar Compra</a>
                    </nav>
                 </div>
                <div class="mt-auto text-xs text-gray-500 px-2">
                    <p>Usuario:</p>
                    <p id="user-email" class="break-words font-medium text-gray-300"></p>
                    <button id="signout-btn" class="w-full mt-4 text-left text-red-400 hover:underline">Cerrar Sesi√≥n</button>
                </div>
            </aside>

            <!-- Contenido Principal -->
            <div class="flex-1">
                <!-- Header para M√≥vil -->
                <header class="md:hidden bg-gray-800 p-4 flex items-center space-x-4">
                    <button id="open-sidebar-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                        </svg>
                    </button>
                    <h2 id="page-title-mobile" class="text-xl font-bold">Dashboard</h2>
                </header>
                <main class="p-4 sm:p-6 overflow-y-auto">
                <!-- P√°gina: Dashboard -->
                <section id="page-dashboard">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-3xl font-bold hidden md:block">Dashboard</h2>
                        <button id="analyze-sales-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg">‚ú® Analizar Ventas</button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="bg-gray-800 p-6 rounded-xl">
                            <h3 class="text-gray-400 text-lg">Valor del Inventario</h3>
                            <p id="dashboard-inventory-value" class="text-3xl font-bold text-green-400 mt-2">$0.00</p>
                        </div>
                        <div class="bg-gray-800 p-6 rounded-xl">
                            <h3 class="text-gray-400 text-lg">Ingresos por Ventas</h3>
                            <p id="dashboard-total-revenue" class="text-3xl font-bold text-blue-400 mt-2">$0.00</p>
                        </div>
                        <div class="bg-gray-800 p-6 rounded-xl">
                            <h3 class="text-gray-400 text-lg">Egresos por Compras</h3>
                            <p id="dashboard-total-purchases" class="text-3xl font-bold text-red-400 mt-2">$0.00</p>
                        </div>
                        <div class="bg-gray-800 p-6 rounded-xl">
                            <h3 class="text-gray-400 text-lg">Productos en Stock</h3>
                            <p id="dashboard-products-count" class="text-3xl font-bold mt-2">0</p>
                        </div>
                    </div>
                     <div class="mt-8 bg-gray-800 p-6 rounded-xl">
                        <h3 class="text-xl font-bold mb-4">Ventas Recientes</h3>
                        <div id="dashboard-recent-sales" class="max-h-80 overflow-y-auto">
                            <p class="text-gray-500">No hay ventas registradas a√∫n.</p>
                        </div>
                    </div>
                </section>

                <!-- P√°gina: Inventario -->
                <section id="page-inventory" class="hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-3xl font-bold hidden md:block">Inventario</h2>
                        <div class="flex flex-wrap gap-2">
                            <button id="import-csv-btn" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg">Importar</button>
                            <button id="export-csv-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">Exportar</button>
                            <button id="add-product-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">A√±adir</button>
                        </div>
                    </div>
                    <input type="file" id="csv-file-input" class="hidden" accept=".csv">
                    <div class="bg-gray-800 rounded-xl overflow-x-auto">
                        <table class="w-full text-left min-w-[700px]">
                            <thead class="bg-gray-700">
                                <tr>
                                    <th class="p-4">Producto</th>
                                    <th class="p-4">Cantidad</th>
                                    <th class="p-4">Precio Unit.</th>
                                    <th class="p-4">Valor Total</th>
                                    <th class="p-4">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="inventory-table-body">
                               <!-- Las filas de productos se insertar√°n aqu√≠ -->
                            </tbody>
                        </table>
                    </div>
                </section>

                <!-- P√°gina: Realizar Venta -->
                <section id="page-sales" class="hidden">
                     <h2 class="text-3xl font-bold mb-6 hidden md:block">Realizar Venta</h2>
                    <div class="bg-gray-800 p-6 rounded-xl">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                            <div>
                                <label for="client-name" class="block text-sm font-medium text-gray-400 mb-1">Nombre del Cliente</label>
                                <input type="text" id="client-name" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg" placeholder="Ej: Juan P√©rez" required>
                            </div>
                            <div>
                                <label for="client-phone" class="block text-sm font-medium text-gray-400 mb-1">Tel√©fono (Opcional)</label>
                                <input type="tel" id="client-phone" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg" placeholder="Ej: 3001234567">
                            </div>
                            <div>
                                <label for="payment-method" class="block text-sm font-medium text-gray-400 mb-1">Medio de Pago</label>
                                <select id="payment-method" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg" required>
                                    <option value="Efectivo">Efectivo</option>
                                    <option value="Transferencia">Transferencia</option>
                                    <option value="Tarjeta">Tarjeta</option>
                                </select>
                            </div>
                        </div>
                        <div id="sale-items-container" class="space-y-4 mb-4">
                            <!-- Items de venta se a√±adir√°n aqu√≠ -->
                        </div>
                        <button id="add-sale-item-btn" class="text-blue-400 hover:text-blue-300 mb-6">+ A√±adir otro producto</button>
                        <div class="border-t border-gray-700 pt-4 mt-4 text-right">
                            <p class="text-2xl font-bold">Total: <span id="sale-total" class="text-green-400">$0.00</span></p>
                        </div>
                        <button id="process-sale-btn" class="w-full mt-6 bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg">Procesar Venta</button>
                    </div>
                </section>

                <!-- P√°gina: Registrar Compra -->
                <section id="page-purchases" class="hidden">
                    <h2 class="text-3xl font-bold mb-6 hidden md:block">Registrar Compra</h2>
                    <div class="bg-gray-800 p-6 rounded-xl">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                            <div>
                                <label for="supplier-name" class="block text-sm font-medium text-gray-400 mb-1">Nombre del Proveedor</label>
                                <input type="text" id="supplier-name" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg" placeholder="Ej: Proveedor XYZ" required>
                            </div>
                             <div>
                                <label for="supplier-phone" class="block text-sm font-medium text-gray-400 mb-1">Tel√©fono (Opcional)</label>
                                <input type="tel" id="supplier-phone" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg" placeholder="Ej: 3001234567">
                            </div>
                        </div>
                        <div id="purchase-items-container" class="space-y-4 mb-4">
                            <!-- Items de compra se a√±adir√°n aqu√≠ -->
                        </div>
                        <button id="add-purchase-item-btn" class="text-blue-400 hover:text-blue-300 mb-6">+ A√±adir otro producto</button>
                        <div class="border-t border-gray-700 pt-4 mt-4 text-right">
                            <p class="text-2xl font-bold">Costo Total: <span id="purchase-total" class="text-red-400">$0.00</span></p>
                        </div>
                        <button id="process-purchase-btn" class="w-full mt-6 bg-orange-600 hover:bg-orange-700 text-white font-bold py-3 px-4 rounded-lg">Registrar Compra</button>
                    </div>
                </section>
                </main>
            </div>
        </div>
    </div>


    <!-- MODALES DE LA APLICACI√ìN -->

    <!-- Modal para A√±adir/Editar Producto -->
    <div id="product-modal" class="modal-hidden fixed inset-0 bg-black bg-opacity-70 items-center justify-center z-50 overflow-y-auto p-4">
        <div class="bg-gray-800 p-8 rounded-xl w-full max-w-md">
            <h2 id="modal-title" class="text-2xl font-bold mb-6">A√±adir Producto</h2>
            <form id="product-form">
                <input type="hidden" id="product-id">
                <div class="space-y-4">
                    <div>
                        <label for="product-name" class="block text-sm font-medium text-gray-400 mb-1">Nombre del Producto</label>
                        <div class="flex items-center space-x-2">
                            <input type="text" id="product-name" class="flex-grow p-3 bg-gray-700 border border-gray-600 rounded-lg" required>
                            <button type="button" id="generate-description-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-3 rounded-lg text-sm" title="Generar descripci√≥n con IA">‚ú®</button>
                        </div>
                    </div>
                    <div>
                        <label for="product-description" class="block text-sm font-medium text-gray-400 mb-1">Descripci√≥n</label>
                        <textarea id="product-description" rows="3" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg" placeholder="Descripci√≥n del producto..."></textarea>
                    </div>
                    <div>
                        <label for="product-quantity" class="block text-sm font-medium text-gray-400 mb-1">Cantidad</label>
                        <input type="number" id="product-quantity" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg" required min="0">
                    </div>
                    <div>
                        <label for="product-purchase-price" class="block text-sm font-medium text-gray-400 mb-1">Precio de Compra ($)</label>
                        <input type="number" id="product-purchase-price" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg" required min="0" step="0.01">
                    </div>
                    <div>
                        <label for="product-selling-price" class="block text-sm font-medium text-gray-400 mb-1">Precio de Venta ($)</label>
                        <input type="number" id="product-selling-price" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg" required min="0" step="0.01">
                    </div>
                </div>
                <div id="product-modal-error" class="text-red-400 text-sm mt-4 hidden"></div>
                <div class="mt-8 flex justify-end space-x-4">
                    <button type="button" id="cancel-product-modal" class="bg-gray-600 hover:bg-gray-700 text-white py-2 px-4 rounded-lg">Cancelar</button>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Confirmaci√≥n de Borrado -->
    <div id="delete-confirm-modal" class="modal-hidden fixed inset-0 bg-black bg-opacity-70 items-center justify-center z-50 p-4">
        <div class="bg-gray-800 p-8 rounded-xl w-full max-w-sm">
            <h2 class="text-xl font-bold mb-4">Confirmar Eliminaci√≥n</h2>
            <p class="text-gray-400 mb-6">¬øEst√°s seguro de que quieres eliminar este producto? Esta acci√≥n no se puede deshacer.</p>
            <div class="flex justify-end space-x-4">
                <button type="button" id="cancel-delete-btn" class="bg-gray-600 hover:bg-gray-700 text-white py-2 px-4 rounded-lg">Cancelar</button>
                <button type="button" id="confirm-delete-btn" class="bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded-lg">Eliminar</button>
            </div>
        </div>
    </div>

    <!-- Modal de An√°lisis de Ventas con IA -->
    <div id="analysis-modal" class="modal-hidden fixed inset-0 bg-black bg-opacity-70 items-center justify-center z-50 p-4">
        <div class="bg-gray-800 p-8 rounded-xl w-full max-w-2xl">
            <div class="flex justify-between items-start mb-4">
                <h2 class="text-2xl font-bold text-purple-400">‚ú® An√°lisis de Ventas</h2>
                <button id="close-analysis-modal" class="text-gray-400 hover:text-white">&times;</button>
            </div>
            <div class="mb-6">
                <h3 class="text-lg font-semibold mb-2 text-gray-300">Productos M√°s Vendidos (por cantidad)</h3>
                <canvas id="sales-chart"></canvas>
            </div>
            <div>
                 <h3 class="text-lg font-semibold mb-2 text-gray-300">Resumen y Sugerencias IA</h3>
                 <div id="analysis-content" class="text-gray-300 prose">
                    <!-- El contenido generado por IA ir√° aqu√≠ -->
                 </div>
            </div>
        </div>
    </div>
    
    <!-- Modal de Importaci√≥n CSV -->
    <div id="import-modal" class="modal-hidden fixed inset-0 bg-black bg-opacity-70 items-center justify-center z-50 p-4">
        <div class="bg-gray-800 p-8 rounded-xl w-full max-w-lg">
            <h2 class="text-2xl font-bold mb-4">Importar Productos desde CSV</h2>
            <p class="text-gray-400 mb-6">Selecciona un archivo .csv para importar tus productos. Aseg√∫rate de que el archivo tenga las siguientes columnas en el orden correcto:</p>
            <div class="bg-gray-900 p-4 rounded-lg text-sm font-mono text-gray-300 mb-6">
                Nombre,Descripci√≥n,Cantidad,Precio Compra,Precio Venta
            </div>
            <p class="text-xs text-gray-500 mb-6">La primera fila debe contener estos encabezados exactos. No incluyas el s√≠mbolo de moneda en los precios.</p>
            <div class="flex justify-end space-x-4">
                <button type="button" id="cancel-import-btn" class="bg-gray-600 hover:bg-gray-700 text-white py-2 px-4 rounded-lg">Cancelar</button>
                <button type="button" id="confirm-import-btn" class="bg-teal-600 hover:bg-teal-700 text-white py-2 px-4 rounded-lg">Seleccionar Archivo</button>
            </div>
        </div>
    </div>


    <script type="module">
        // --- IMPORTS Y CONFIGURACI√ìN DE FIREBASE ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, deleteDoc, query, serverTimestamp, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyBXHEzRkXedFKBH5vzGq_QB22bZ2KwJqxc",
          authDomain: "gestor-pro-4be33.firebaseapp.com",
          projectId: "gestor-pro-4be33",
          storageBucket: "gestor-pro-4be33.appspot.com",
          messagingSenderId: "438582866058",
          appId: "1:438582866058:web:e8fc2dc4ef93d166b23d73",
          measurementId: "G-438T861SKN"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let userId = null;
        let productsCache = [];
        let salesCache = [];
        let purchasesCache = [];
        let productToDeleteId = null;
        let salesChartInstance = null;

        let unsubscribeProducts = () => {};
        let unsubscribeSales = () => {};
        let unsubscribePurchases = () => {};
        
        // --- ELEMENTOS DEL DOM ---
        const authContainer = document.getElementById('auth-container');
        const appContainer = document.getElementById('app-container');
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebar-overlay');
        const openSidebarBtn = document.getElementById('open-sidebar-btn');
        const closeSidebarBtn = document.getElementById('close-sidebar-btn');
        const mobilePageTitle = document.getElementById('page-title-mobile');

        // --- MANEJO DEL SIDEBAR M√ìVIL ---
        function openSidebar() {
            sidebar.classList.remove('-translate-x-full');
            sidebarOverlay.classList.remove('hidden');
        }

        function closeSidebar() {
            sidebar.classList.add('-translate-x-full');
            sidebarOverlay.classList.add('hidden');
        }

        openSidebarBtn.addEventListener('click', openSidebar);
        closeSidebarBtn.addEventListener('click', closeSidebar);
        sidebarOverlay.addEventListener('click', closeSidebar);
        
        // --- MANEJO DE AUTENTICACI√ìN ---
        async function initializeAuth() {
            try {
                await setPersistence(auth, browserLocalPersistence);
            } catch (error) {
                console.error("No se pudo establecer la persistencia de la sesi√≥n:", error);
            }

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    document.getElementById('user-email').textContent = user.email;
                    authContainer.classList.add('hidden');
                    appContainer.classList.remove('hidden');
                    setupRealtimeListeners();
                } else {
                    userId = null;
                    appContainer.classList.add('hidden');
                    authContainer.classList.remove('hidden');
                    unsubscribeProducts();
                    unsubscribeSales();
                    unsubscribePurchases();
                    productsCache = []; salesCache = []; purchasesCache = [];
                    renderInventory([]);
                    updateDashboard([], [], []);
                }
            });
        }
        initializeAuth();
        
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const errorEl = document.getElementById('auth-error');
            errorEl.classList.add('hidden');
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                errorEl.textContent = "Correo o contrase√±a incorrectos.";
                errorEl.classList.remove('hidden');
            }
        });
        
        document.getElementById('signup-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            const errorEl = document.getElementById('auth-error');
            errorEl.classList.add('hidden');
            try {
                await createUserWithEmailAndPassword(auth, email, password);
            } catch (error) {
                if (error.code === 'auth/email-already-in-use') errorEl.textContent = "Este correo ya est√° registrado.";
                else if (error.code === 'auth/weak-password') errorEl.textContent = "La contrase√±a debe tener al menos 6 caracteres.";
                else errorEl.textContent = "Error al crear la cuenta.";
                errorEl.classList.remove('hidden');
            }
        });

        document.getElementById('signout-btn').addEventListener('click', () => signOut(auth));
        
        document.getElementById('show-signup').addEventListener('click', (e) => {
            e.preventDefault();
            document.getElementById('login-form').classList.add('hidden');
            document.getElementById('signup-form').classList.remove('hidden');
            document.getElementById('login-link-text').classList.add('hidden');
            document.getElementById('signup-link-text').classList.remove('hidden');
        });

        document.getElementById('show-login').addEventListener('click', (e) => {
            e.preventDefault();
            document.getElementById('signup-form').classList.add('hidden');
            document.getElementById('login-form').classList.remove('hidden');
            document.getElementById('signup-link-text').classList.add('hidden');
            document.getElementById('login-link-text').classList.remove('hidden');
        });
        
        // --- VISUALIZAR CONTRASE√ëA ---
        function setupPasswordToggle(inputId, buttonId) {
            const passwordInput = document.getElementById(inputId);
            const toggleButton = document.getElementById(buttonId);
            const showIcon = toggleButton.querySelector('.show-icon');
            const hideIcon = toggleButton.querySelector('.hide-icon');

            toggleButton.addEventListener('click', () => {
                if (passwordInput.type === 'password') {
                    passwordInput.type = 'text';
                    showIcon.classList.add('hidden');
                    hideIcon.classList.remove('hidden');
                } else {
                    passwordInput.type = 'password';
                    hideIcon.classList.add('hidden');
                    showIcon.classList.remove('hidden');
                }
            });
        }
        setupPasswordToggle('login-password', 'toggle-login-password');
        setupPasswordToggle('signup-password', 'toggle-signup-password');

        // --- NAVEGACI√ìN ---
        const navLinks = { dashboard: document.getElementById('nav-dashboard'), inventory: document.getElementById('nav-inventory'), sales: document.getElementById('nav-sales'), purchases: document.getElementById('nav-purchases') };
        const pages = { dashboard: document.getElementById('page-dashboard'), inventory: document.getElementById('page-inventory'), sales: document.getElementById('page-sales'), purchases: document.getElementById('page-purchases') };

        function switchPage(pageName) {
            Object.keys(pages).forEach(key => {
                pages[key].classList.add('hidden');
                navLinks[key].classList.remove('active');
            });
            pages[pageName].classList.remove('hidden');
            navLinks[pageName].classList.add('active');
            mobilePageTitle.textContent = navLinks[pageName].textContent;
            closeSidebar();
        }

        Object.keys(navLinks).forEach(key => navLinks[key].addEventListener('click', (e) => { e.preventDefault(); switchPage(key); }));
        
        function formatCurrency(value) {
            return new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0 }).format(value || 0);
        }

        const inventoryTableBody = document.getElementById('inventory-table-body');
        
        function renderInventory(products) {
            inventoryTableBody.innerHTML = '';
            if (products.length === 0) {
                 inventoryTableBody.innerHTML = `<tr><td colspan="5" class="p-4 text-center text-gray-500">No hay productos.</td></tr>`;
                 return;
            }
            products.forEach(product => {
                const totalValue = product.sellingPrice * product.quantity;
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-700 hover:bg-gray-700/50';
                row.innerHTML = `
                    <td class="p-4 font-medium">
                        <div>${product.name}</div>
                        <div class="text-xs text-gray-400 md:hidden" title="${product.description || ''}">${(product.description || '').substring(0, 30)}...</div>
                    </td>
                    <td class="p-4">${product.quantity}</td>
                    <td class="p-4">${formatCurrency(product.sellingPrice)}</td>
                    <td class="p-4 font-medium text-green-400">${formatCurrency(totalValue)}</td>
                    <td class="p-4 flex items-center space-x-2">
                        <button class="edit-btn p-2 rounded-md hover:bg-blue-500/20" data-id="${product.id}" title="Editar">‚úèÔ∏è</button>
                        <button class="delete-btn p-2 rounded-md hover:bg-red-500/20" data-id="${product.id}" title="Eliminar">üóëÔ∏è</button>
                    </td>
                `;
                inventoryTableBody.appendChild(row);
            });
        }
        
        const saleItemsContainer = document.getElementById('sale-items-container');

        function createSaleItemRow() {
            const div = document.createElement('div');
            div.className = 'flex items-center space-x-2 sale-item-row';
            
            let options = productsCache
                .filter(p => p.quantity > 0)
                .map(p => `<option value="${p.id}" data-price="${p.sellingPrice}" data-stock="${p.quantity}">${p.name} (Stock: ${p.quantity})</option>`).join('');

            div.innerHTML = `
                <select class="product-select flex-1 p-3 bg-gray-700 border border-gray-600 rounded-lg">
                    <option value="">Selecciona un producto</option>
                    ${options}
                </select>
                <input type="number" class="sale-quantity w-24 p-3 bg-gray-700 border border-gray-600 rounded-lg" placeholder="Cant." min="1">
                <p class="item-total w-32 text-right font-medium">$0.00</p>
                <button class="remove-sale-item-btn text-red-400 hover:text-red-300 p-2">&times;</button>
            `;
            saleItemsContainer.appendChild(div);
        }
        
        function updateSaleTotals() {
            let total = 0;
            const rows = saleItemsContainer.querySelectorAll('.sale-item-row');
            rows.forEach(row => {
                const productSelect = row.querySelector('.product-select');
                const quantityInput = row.querySelector('.sale-quantity');
                const itemTotalEl = row.querySelector('.item-total');
                const selectedOption = productSelect.options[productSelect.selectedIndex];
                const price = parseFloat(selectedOption.dataset.price) || 0;
                const quantity = parseInt(quantityInput.value) || 0;
                const itemTotal = price * quantity;
                itemTotalEl.textContent = formatCurrency(itemTotal);
                total += itemTotal;
            });
            document.getElementById('sale-total').textContent = formatCurrency(total);
        }

        document.getElementById('add-sale-item-btn').addEventListener('click', createSaleItemRow);

        saleItemsContainer.addEventListener('change', (e) => {
            if (e.target.classList.contains('product-select') || e.target.classList.contains('sale-quantity')) {
                updateSaleTotals();
            }
        });

        saleItemsContainer.addEventListener('click', (e) => {
            if (e.target.closest('.remove-sale-item-btn')) {
                e.target.closest('.sale-item-row').remove();
                updateSaleTotals();
            }
        });

        document.getElementById('process-sale-btn').addEventListener('click', async () => {
            if (!userId) { alert("Error de sesi√≥n."); return; }
            const clientName = document.getElementById('client-name').value.trim();
            const clientPhone = document.getElementById('client-phone').value.trim();
            const paymentMethod = document.getElementById('payment-method').value; 
            if (!clientName || !paymentMethod) { alert("Cliente y medio de pago son obligatorios."); return; }
            
            const saleItems = [];
            const rows = document.getElementById('sale-items-container').querySelectorAll('.sale-item-row');
             
            for (const row of rows) {
                const productSelect = row.querySelector('.product-select');
                const quantityInput = row.querySelector('.sale-quantity');
                const selectedOption = productSelect.options[productSelect.selectedIndex];
                const productId = selectedOption.value;
                const quantity = parseInt(quantityInput.value);
                if (!productId || isNaN(quantity) || quantity <= 0) continue; 
                const stock = parseInt(selectedOption.dataset.stock);
                if (quantity > stock) {
                    alert(`No hay suficiente stock para "${selectedOption.textContent}". Disponible: ${stock}`);
                    return; 
                }
                saleItems.push({ productId, quantity, price: parseFloat(selectedOption.dataset.price), name: selectedOption.textContent.split(' (')[0] });
            }
             
            if (saleItems.length === 0) { alert("No has a√±adido ning√∫n producto v√°lido a la venta."); return; }
            const totalSaleAmount = saleItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
             
            try {
                const batch = writeBatch(db);
                const productsPath = `users/${userId}/products`;
                const salesPath = `users/${userId}/sales`;
                
                saleItems.forEach(item => {
                    const productRef = doc(db, productsPath, item.productId);
                    const currentProduct = productsCache.find(p => p.id === item.productId);
                    if (currentProduct) {
                       batch.update(productRef, { quantity: currentProduct.quantity - item.quantity });
                    }
                });
                const saleRef = doc(collection(db, salesPath));
                batch.set(saleRef, {
                    userId,
                    clientName,
                    clientPhone,
                    items: saleItems,
                    total: totalSaleAmount,
                    paymentMethod,
                    createdAt: serverTimestamp()
                });
                await batch.commit();
                alert("¬°Venta procesada con √©xito!");
                document.getElementById('client-name').value = '';
                document.getElementById('client-phone').value = '';
                document.getElementById('payment-method').value = 'Efectivo';
                document.getElementById('sale-items-container').innerHTML = '';
                createSaleItemRow();
                updateSaleTotals();
             } catch (error) { 
                 console.error("Error al procesar la venta:", error);
                 alert("No se pudo procesar la venta."); 
             }
        });
        
        function updateDashboard(products, sales, purchases) {
            const inventoryValue = products.reduce((sum, p) => sum + (p.purchasePrice * p.quantity), 0);
            const totalRevenue = sales.reduce((sum, s) => sum + s.total, 0);
            const totalPurchases = purchases.reduce((sum, p) => sum + p.total, 0);
            const productsCount = products.reduce((sum, p) => sum + p.quantity, 0);
            document.getElementById('dashboard-inventory-value').textContent = formatCurrency(inventoryValue);
            document.getElementById('dashboard-total-revenue').textContent = formatCurrency(totalRevenue);
            document.getElementById('dashboard-total-purchases').textContent = formatCurrency(totalPurchases);
            document.getElementById('dashboard-products-count').textContent = productsCount;
            const recentSalesEl = document.getElementById('dashboard-recent-sales');
            recentSalesEl.innerHTML = '';
            if (sales.length === 0) { recentSalesEl.innerHTML = '<p class="text-gray-500">No hay ventas.</p>'; return; }
            const sortedSales = sales.filter(s => s.createdAt).sort((a, b) => b.createdAt.toDate() - a.createdAt.toDate()).slice(0, 10);
            sortedSales.forEach(sale => {
                const saleDiv = document.createElement('div');
                saleDiv.className = 'p-3 border-b border-gray-700 text-sm';
                const itemsSummary = sale.items.map(item => `${item.quantity}x ${item.name}`).join(', ');
                saleDiv.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="font-bold text-gray-200">${sale.clientName || 'Venta General'}</p>
                            <p class="text-gray-400">${itemsSummary}</p>
                        </div>
                        <span class="text-green-400 font-bold text-right">${formatCurrency(sale.total)}</span>
                    </div>
                    <div class="flex justify-between items-center mt-1">
                        <span class="text-xs px-2 py-0.5 rounded-full bg-blue-500/20 text-blue-300">${sale.paymentMethod || 'N/A'}</span>
                        <span class="text-xs text-gray-500">${sale.createdAt.toDate().toLocaleString('es-CO')}</span>
                    </div>`;
                recentSalesEl.appendChild(saleDiv);
            });
        }
        
        function setupRealtimeListeners() {
            if (!userId) return;
            unsubscribeProducts(); unsubscribeSales(); unsubscribePurchases();
            const productsPath = `users/${userId}/products`;
            const salesPath = `users/${userId}/sales`;
            const purchasesPath = `users/${userId}/purchases`;
            unsubscribeProducts = onSnapshot(query(collection(db, productsPath)), (snapshot) => {
                productsCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderInventory(productsCache);
                if (!pages.sales.classList.contains('hidden')) { document.getElementById('sale-items-container').innerHTML = ''; createSaleItemRow(); }
                if (!pages.purchases.classList.contains('hidden')) { document.getElementById('purchase-items-container').innerHTML = ''; createPurchaseItemRow(); }
                updateDashboard(productsCache, salesCache, purchasesCache);
            });
            unsubscribeSales = onSnapshot(query(collection(db, salesPath)), (snapshot) => {
                 salesCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                 updateDashboard(productsCache, salesCache, purchasesCache);
            });
            unsubscribePurchases = onSnapshot(query(collection(db, purchasesPath)), (snapshot) => {
                 purchasesCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                 updateDashboard(productsCache, salesCache, purchasesCache);
            });
        }
        
        const purchaseItemsContainer = document.getElementById('purchase-items-container');

        function createPurchaseItemRow() {
            const div = document.createElement('div');
            div.className = 'flex items-center space-x-2 purchase-item-row';
            let options = productsCache.map(p => `<option value="${p.id}" data-price="${p.purchasePrice}">${p.name}</option>`).join('');
            div.innerHTML = `
                <select class="product-select flex-1 p-3 bg-gray-700 border border-gray-600 rounded-lg">
                    <option value="">Selecciona un producto</option>
                    ${options}
                </select>
                <input type="number" class="purchase-quantity w-24 p-3 bg-gray-700 border border-gray-600 rounded-lg" placeholder="Cant." min="1">
                <p class="item-total w-32 text-right font-medium">$0.00</p>
                <button class="remove-purchase-item-btn text-red-400 hover:text-red-300 p-2">&times;</button>
            `;
            purchaseItemsContainer.appendChild(div);
        }

        function updatePurchaseTotals() {
            let total = 0;
            const rows = purchaseItemsContainer.querySelectorAll('.purchase-item-row');
            rows.forEach(row => {
                const productSelect = row.querySelector('.product-select');
                const quantityInput = row.querySelector('.purchase-quantity');
                const itemTotalEl = row.querySelector('.item-total');
                const selectedOption = productSelect.options[productSelect.selectedIndex];
                const price = parseFloat(selectedOption.dataset.price) || 0;
                const quantity = parseInt(quantityInput.value) || 0;
                const itemTotal = price * quantity;
                itemTotalEl.textContent = formatCurrency(itemTotal);
                total += itemTotal;
            });
            document.getElementById('purchase-total').textContent = formatCurrency(total);
        }

        document.getElementById('add-purchase-item-btn').addEventListener('click', createPurchaseItemRow);
        
        purchaseItemsContainer.addEventListener('change', (e) => {
            if (e.target.classList.contains('product-select') || e.target.classList.contains('purchase-quantity')) {
                updatePurchaseTotals();
            }
        });

        purchaseItemsContainer.addEventListener('click', (e) => {
            if (e.target.closest('.remove-purchase-item-btn')) {
                e.target.closest('.purchase-item-row').remove();
                updatePurchaseTotals();
            }
        });

        document.getElementById('process-purchase-btn').addEventListener('click', async () => {
             if (!userId) { alert("Error de sesi√≥n."); return; }
             const supplierName = document.getElementById('supplier-name').value.trim();
             const supplierPhone = document.getElementById('supplier-phone').value.trim();
             if (!supplierName) { alert("El nombre del proveedor es obligatorio."); return; }
             const purchaseItems = [];
             const rows = purchaseItemsContainer.querySelectorAll('.purchase-item-row');
             for (const row of rows) {
                const productSelect = row.querySelector('.product-select');
                const quantityInput = row.querySelector('.purchase-quantity');
                const selectedOption = productSelect.options[productSelect.selectedIndex];
                const productId = selectedOption.value;
                const quantity = parseInt(quantityInput.value);
                if (!productId || isNaN(quantity) || quantity <= 0) continue; 
                const price = parseFloat(selectedOption.dataset.price);
                purchaseItems.push({ productId, quantity, price, name: selectedOption.textContent });
             }
             if (purchaseItems.length === 0) { alert("No has a√±adido ning√∫n producto v√°lido a la compra."); return; }
             const totalPurchaseAmount = purchaseItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
             try {
                const batch = writeBatch(db);
                const productsPath = `users/${userId}/products`;
                const purchasesPath = `users/${userId}/purchases`;
                purchaseItems.forEach(item => {
                    const productRef = doc(db, productsPath, item.productId);
                    const currentProduct = productsCache.find(p => p.id === item.productId);
                    if (currentProduct) {
                       const newStock = currentProduct.quantity + item.quantity;
                       batch.update(productRef, { quantity: newStock });
                    }
                });
                const purchaseRef = doc(collection(db, purchasesPath));
                batch.set(purchaseRef, {
                    userId,
                    supplierName,
                    supplierPhone,
                    items: purchaseItems,
                    total: totalPurchaseAmount,
                    createdAt: serverTimestamp()
                });
                await batch.commit();
                alert("¬°Compra registrada con √©xito!");
                document.getElementById('supplier-name').value = '';
                document.getElementById('supplier-phone').value = '';
                purchaseItemsContainer.innerHTML = '';
                createPurchaseItemRow();
                updatePurchaseTotals();
             } catch (error) { 
                 console.error("Error al registrar la compra:", error); 
                 alert("No se pudo registrar la compra."); 
             }
        });
        
        const productModal = document.getElementById('product-modal');
        const productForm = document.getElementById('product-form');

        document.getElementById('add-product-btn').addEventListener('click', () => {
            productForm.reset();
            document.getElementById('product-id').value = '';
            document.getElementById('modal-title').textContent = 'A√±adir Producto';
            productModal.classList.remove('modal-hidden');
            productModal.classList.add('modal-visible');
        });
        
        document.getElementById('cancel-product-modal').addEventListener('click', () => {
             productModal.classList.add('modal-hidden');
             productModal.classList.remove('modal-visible');
        });
        
        productForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const errorEl = document.getElementById('product-modal-error');
            errorEl.classList.add('hidden');

            const id = document.getElementById('product-id').value;
            const name = document.getElementById('product-name').value.trim();
            const description = document.getElementById('product-description').value.trim();
            const quantity = parseInt(document.getElementById('product-quantity').value);
            const purchasePrice = parseFloat(document.getElementById('product-purchase-price').value);
            const sellingPrice = parseFloat(document.getElementById('product-selling-price').value);

            if (!name) {
                errorEl.textContent = 'El nombre del producto es obligatorio.';
                errorEl.classList.remove('hidden');
                return;
            }
            if (isNaN(quantity) || isNaN(purchasePrice) || isNaN(sellingPrice)) {
                errorEl.textContent = 'Cantidad y precios deben ser n√∫meros v√°lidos.';
                errorEl.classList.remove('hidden');
                return;
            }
            
            const productData = { name, description, quantity, purchasePrice, sellingPrice, userId };
            const productsPath = `users/${userId}/products`;
            
            try {
                if (id) {
                    await updateDoc(doc(db, productsPath, id), productData);
                } else {
                    await addDoc(collection(db, productsPath), productData);
                }
                productModal.classList.add('modal-hidden');
                productModal.classList.remove('modal-visible');
            } catch (error) {
                console.error("Error al guardar el producto:", error);
                errorEl.textContent = "Error al guardar el producto. Int√©ntalo de nuevo.";
                errorEl.classList.remove('hidden');
            }
        });

        inventoryTableBody.addEventListener('click', (e) => {
            const btn = e.target.closest('button');
            if (!btn || !userId) return;
            const id = btn.dataset.id;
            if (btn.classList.contains('edit-btn')) {
                const product = productsCache.find(p => p.id === id);
                if (product) {
                    document.getElementById('product-id').value = product.id;
                    document.getElementById('product-name').value = product.name;
                    document.getElementById('product-description').value = product.description || '';
                    document.getElementById('product-quantity').value = product.quantity;
                    document.getElementById('product-purchase-price').value = product.purchasePrice;
                    document.getElementById('product-selling-price').value = product.sellingPrice;
                    document.getElementById('modal-title').textContent = 'Editar Producto';
                    productModal.classList.remove('modal-hidden');
                    productModal.classList.add('modal-visible');
                }
            } else if (btn.classList.contains('delete-btn')) {
                 productToDeleteId = id;
                 document.getElementById('delete-confirm-modal').classList.remove('modal-hidden');
                 document.getElementById('delete-confirm-modal').classList.add('modal-visible');
            }
        });

        document.getElementById('cancel-delete-btn').addEventListener('click', () => {
            document.getElementById('delete-confirm-modal').classList.add('modal-hidden');
            document.getElementById('delete-confirm-modal').classList.remove('modal-visible');
            productToDeleteId = null;
        });

        document.getElementById('confirm-delete-btn').addEventListener('click', async () => {
            if (!productToDeleteId || !userId) return;
            const productsPath = `users/${userId}/products`;
            try {
                await deleteDoc(doc(db, productsPath, productToDeleteId));
            } catch (error) { 
                alert("No se pudo eliminar el producto.");
            } finally {
                document.getElementById('delete-confirm-modal').classList.add('modal-hidden');
                document.getElementById('delete-confirm-modal').classList.remove('modal-visible');
                productToDeleteId = null;
            }
        });
        
        // --- IMPORT/EXPORT/ANALYSIS BUTTONS & MODALS ---
        document.getElementById('export-csv-btn').addEventListener('click', () => {
            if (productsCache.length === 0) { alert("No hay productos para exportar."); return; }
            const headers = ["Nombre", "Descripci√≥n", "Cantidad", "Precio Compra", "Precio Venta"];
            const rows = productsCache.map(p => [ `"${(p.name || '').replace(/"/g, '""')}"`, `"${(p.description || '').replace(/"/g, '""')}"`, p.quantity, p.purchasePrice, p.sellingPrice ].join(','));
            const csvContent = [headers.join(','), ...rows].join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "inventario.csv";
            link.click();
        });

        document.getElementById('import-csv-btn').addEventListener('click', () => document.getElementById('import-modal').classList.remove('modal-hidden'));
        document.getElementById('cancel-import-btn').addEventListener('click', () => document.getElementById('import-modal').classList.add('modal-hidden'));
        document.getElementById('confirm-import-btn').addEventListener('click', () => document.getElementById('csv-file-input').click());

        document.getElementById('csv-file-input').addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                const text = e.target.result;
                const lines = text.split(/\r?\n/).filter(line => line.trim() !== '');

                if (lines.length < 2) {
                    alert("El archivo CSV est√° vac√≠o o solo contiene la cabecera.");
                    return;
                }
                
                function parseCsvLine(line) {
                    const result = [];
                    let current = '';
                    let inQuotes = false;
                    for (let i = 0; i < line.length; i++) {
                        const char = line[i];
                        if (char === '"' && (i === 0 || line[i-1] !== '\\')) { 
                            inQuotes = !inQuotes;
                        } else if (char === ',' && !inQuotes) {
                            result.push(current.replace(/^"|"$/g, '').trim()); 
                            current = '';
                        } else {
                            current += char;
                        }
                    }
                    result.push(current.replace(/^"|"$/g, '').trim());
                    return result;
                }

                const header = parseCsvLine(lines[0]);
                const expectedHeader = ["Nombre", "Descripci√≥n", "Cantidad", "Precio Compra", "Precio Venta"];
                if (header.length !== expectedHeader.length || !header.every((value, index) => value === expectedHeader[index])) {
                    alert(`El formato de la cabecera es incorrecto. Se esperaba: ${expectedHeader.join(',')}`);
                    return;
                }

                const productsToImport = [];
                for (let i = 1; i < lines.length; i++) {
                    const values = parseCsvLine(lines[i]);
                    if (values.length !== 5) {
                        console.warn(`Skipping malformed line ${i+1}: ${lines[i]}`);
                        continue; 
                    }
                    
                    const name = values[0];
                    const description = values[1];
                    const quantity = parseInt(values[2]);
                    const purchasePrice = parseFloat(values[3]);
                    const sellingPrice = parseFloat(values[4]);

                    if (!name || isNaN(quantity) || isNaN(purchasePrice) || isNaN(sellingPrice)) {
                        console.warn(`Skipping invalid line ${i+1}: ${lines[i]}`);
                        continue;
                    }

                    productsToImport.push({ name, description, quantity, purchasePrice, sellingPrice, userId });
                }
                
                if (productsToImport.length > 0) {
                    try {
                        const batch = writeBatch(db);
                        const productsPath = `users/${userId}/products`;
                        productsToImport.forEach(product => {
                            const newProductRef = doc(collection(db, productsPath));
                            batch.set(newProductRef, product);
                        });
                        await batch.commit();
                        alert(`¬°Se importaron ${productsToImport.length} productos con √©xito!`);
                    } catch (error) {
                        console.error("Error al importar productos:", error);
                        alert("Ocurri√≥ un error durante la importaci√≥n masiva.");
                    }
                } else {
                    alert("No se encontraron productos v√°lidos para importar en el archivo.");
                }
                document.getElementById('import-modal').classList.add('modal-hidden');
            };
            reader.readAsText(file);
            event.target.value = '';
        });
        document.getElementById('analyze-sales-btn').addEventListener('click', () => document.getElementById('analysis-modal').classList.remove('modal-hidden'));
        document.getElementById('close-analysis-modal').addEventListener('click', () => document.getElementById('analysis-modal').classList.add('modal-hidden'));

    </script>
</body>
</html>

